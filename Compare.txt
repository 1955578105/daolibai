这是一个非常经典的控制理论问题。简单来说，LQR 是 MPC 的一种**特殊情况**（或者说极限情况）。

以下是详细的对比分析：

### 1. 什么时候它们的结果是“完全一样”的？

当 **MPC** 同时满足以下 4 个条件时，它的输出轨迹和控制律会与 **LQR** 完全一致：

1.  **系统是线性的 (Linear System)**：
    *   模型必须是 $x_{k+1} = Ax_k + Bu_k$。
2.  **没有任何约束 (Unconstrained)**：
    *   没有 $u_{min} \le u \le u_{max}$（电机力限制）。
    *   没有 $x_{min} \le x \le x_{max}$（位置限制）。
    *   即允许电机输出无限大的力，允许小车跑无限远。
3.  **代价函数是二次的 (Quadratic Cost)**：
    *   目标都是最小化 $J = \sum (x^T Q x + u^T R u)$。
4.  **MPC 的预测时域是无限的 (Infinite Horizon)**：
    *   LQR 默认看的是无限远的未来 ($N \to \infty$)。
    *   MPC 通常只看未来 $N$ 步。
    *   **关键点**：如果把 MPC 的预测步数 $N$ 设为无穷大，或者在 MPC 的最后一步 ($N$) 加上一个经过特殊计算的**终端代价 (Terminal Cost)**（这个终端代价矩阵 $P$ 来自 LQR 的 Riccati 方程解），那么 MPC 每一算的控制动作 $u$ 就会和 LQR 算出的 $u = -Kx$ 完全一样。

**结论：**
> **无约束的线性 MPC (当 N 足够大或有终端代价时) = LQR**

---

### 2. 什么时候它们“不一样”？

现实世界中，它们通常是不一样的。MPC 之所以在现代机器人（比如波士顿动力）中比 LQR 更流行，就是因为以下几点“不一样”：

#### A. 存在约束 (Constraints) —— 最核心的区别
这是 MPC 的杀手锏。
*   **场景**：你的小车电机最大只能输出 10N 的力 (`ctrlrange="-1 1"` 配合 `gear="10"`）。
*   **LQR**：它不管物理限制。如果 LQR 觉得需要 100N 才能把杆扶正，它就会算出 $u=100$。结果电机只能给 10N，系统大概率就**失稳摔倒**了。
*   **MPC**：它在优化求解时就知道 $u \le 10$。它会寻找一条**“即使只能用 10N 的力，也能慢慢把杆扶正”**的轨迹（比如先往反方向甩一下借力）。

#### B. 预测时域 (Finite Horizon)
*   **LQR**：假设可以调节无限久，追求的是“稳态”最优。
*   **MPC**：通常只看未来 1-2 秒（比如 $N=50$ 步）。
    *   如果 $N$ 太短（短视），MPC 可能会为了眼前的贪婪（快速减小误差）而导致后面撞墙。
    *   LQR 不会有“短视”问题，但在处理突发变化时不如 MPC 灵活。

#### C. 非线性 (Nonlinearity)
*   **LQR**：必须先把倒立摆在“竖直向上”这个点进行**线性化**。如果杆子倒下超过 30 度，线性近似失效，LQR 就算不准了，无法把杆子甩起来（Swing-up）。
*   **NMPC (非线性 MPC)**：直接使用 MuJoCo 的非线性物理模型进行预测。它可以完成从**杆子完全垂下**到**甩上去平衡**的全过程。

---

### 3. 直观比喻

假设你在**开车**：

*   **LQR 像是“老司机下意识反应”**：
    *   它有一套固定的肌肉记忆（矩阵 $K$）。
    *   看到车偏左一点，手就往右修一点。
    *   **优点**：计算极快（毫秒级），反应迅速。
    *   **缺点**：如果前方路断了（约束），或者弯道极急（非线性），肌肉记忆可能反应不过来，直接冲出悬崖。

*   **MPC 像是“理性的赛车手”**：
    *   它每时每刻都在脑子里模拟：“如果我现在踩油门，1秒后车在哪，2秒后在哪...哎呀，3秒后会撞墙，所以我现在必须刹车。”
    *   **优点**：能处理红绿灯、限速、弯道（约束和预测）。
    *   **缺点**：脑子运算量大，如果算得慢，车已经撞上去了。

### 总结建议

| 特性 | LQR | MPC |
| :--- | :--- | :--- |
| **计算速度** | **极快** (离线算好K，在线只做乘法) | **较慢** (在线解优化问题) |
| **物理约束** | 无法处理 (需截断，效果差) | **完美处理** (核心优势) |
| **适用范围** | 平衡点附近的微调 (Stabilization) | 复杂动作、大范围运动 (Swing-up) |
| **你的 Cart-Pole** | 杆子已经在上面时，用 LQR 稳住它 | 杆子掉下来想甩上去，必须用 MPC (或 iLQR) |